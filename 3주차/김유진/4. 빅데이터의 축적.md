# 벌크 형과 스트리밍 형의 데이터 수집
## 객체 스토리지와 데이터 수집
- 객체 스토리지는 네트워크를 거쳐서 파일을 읽고 쓴다
- 데이터를 다수의 하드웨어에 분산
- 객체 스토리지는 데이터양이 많을 때는 우수, 소량의 데이터에서는 비효율
- 시계열 데이터처럼 대량의 작은 파일은 모아서 하나의 큰 파일로 만들기
- 매우 큰 하나의 파일은 나눠서 처리
- 기준은 1메가바이트-1기가바이트 사이가 되도록 분할 또는 병합
## 벌크 형의 데이터 전송
- 데이터 전송을 위한 ETL 서버를 설치
- ETL 프로세스는 일정한 시간 간격을 두 고 정기적으로 실행
- 데이터 전송 신뢰성이 중요한 경우에는 가능한 한 벌크 형 도구를 사용
- 여러 번 데이터 전송을 재실행할 수 있다는 점이 벌크 형의 장점
## 스트리밍 형의 데이터 전송
- 바로 생성되어 저장되지 않은 데이터는 스트리밍 형의 데이터 전송이 필요(웹 브라우저, 모바일 앱, 디바이스)
- 메시지 배송: 다수의 클라이언트에서 계쏙해서 작은 데이터가 전송
- 높은 성능의 서버를 요구
- 메세지 저장에는 NoSQL 데이터베이스를 이용
- 웹 브라우저에서의 메시지 배송
  - 데이터 축적, 나중에 모아서 보내는 경우 많음
  - 서버 상주형 로그 수집 소프트웨어 자주 사용
  - 웹 이벤트 추적
- 모바일 앱 에서의 메시지 배송
  - HTTP 프로토콜을 사용하는 클라이언트
  - 메시지 배송 방식이 웹 브라우저와 동일
  - MBaaS, SDK
- 디바이스로부터의 메시지 배송
  - MQTT: TCP/IP를 사용하여 데이터를 전송하는 프로토콜, Pub/Sub형 메시지 배송
  - 토픽 생성 > 토픽 구독 > 토픽 구독중인 모든 클라이언트에 보내짐
  - 메시지가 처음 생성되는 기기는 클라이언트, 해당 메시지를 먼저 받는 서버를 프런트 엔드라고 함
  - 프런트 엔드가 받은 메세지는 메시지 브로커로 전송

# 메세지 배송의 트레이드 오프
## 메세지 브로커
- 메시지 브로커: 데이터를 일시적으로 축적하는 중산층
- push 형: 송신 측의 제어로 데이터를 보내는 방식
- pull 형: 수신 측의 주도로 데이터를 가져오는 것
- 메시지 브로커는 높은 빈도로 데이터를 쓰는 것에 최적화
- 푸쉬 형의 메시지 배송은 모두 메시지 브로커에 집중, 일정한 빈도로 꺼낸 데이터를 분산 스토리지에 기록
- 메시지 브로커에 써넣은 데이터는 복수의 다른 소비자에 모아서 가져온다
  
## 메시지 배송을 확실하게 실시하는 것은 어렵다
| 제목 | 보장 내용 | 단점 | 특징 |
|---|---|---| --- |
| at most once | 메시지는 한 번만 전송 | 결손 발생 가능성 있음 |
| exactly once | 메시지 손실이나 중복 없이 한 번만 전달 | 코디네이터가 항상 존재한다고 가정할 수 없음, 코디네이터에 의존하면 시간이 너무 소요 | 통신 내용을 중계하는 코디네이터가 필수적|
| at least once | 메시지는 확실히 전달 | 중복 가능성 있음 | 중복 제거(중복을 없애는 구조)가 있으면 중복이 없는 것처럼 보일 수 있음, 이용자에게 중복제거를 맡김 |

## 중복 제거는 높은 비용의 오퍼레이션
- 오프셋(파일안 시작 위치)을 덧붙여 중복되어도 같은 파일을 같은 장소를 덮어쓰게 됨 > 벌크 형처럼 데이터양이 고정된 경우에는 잘 작동
- UUID 등의 고유 ID를 지정하는 방법, 현실적으로 ID는 최근에 받은 것만을 기억하고 그보다 이전 메시지의 중복은 허용
- 빅데이터 메세지 배송에서는 at least once 보장, 중복제거는 하지 않는 것이 표준적 구현
- 분산 스토리지에 기록하는ㄴ 단계에서 중복 없는 상태여야 함
## 데이터 수집의 파이프라인
- 중복을 고려한 시스템 설계: 중복이 있어도 문제가 되지 않는 시스템을 설계할 것, 결제 데이터같은 오차가 허용되지 않는 것은 스트리밍형의 메시지 배송을 피한다.

# 시계열 데이터의 최적화
## 프로세스 시간과 이벤트 시간
- 메시지가 생성된 시간을 이벤트 시간
- 서버가 처리하는 시간을 프로세스 시간
- 며칠 정도의 지연을 예측해서 데이터 분석 고려
## 프로세스 시간에 의한 분할과 문제점
- 활동 사용자 수 집계는 며칠에 걸쳐서 기록될 수 있으므로 '이벤트 시간'보다 며칠 정도 지난 시점에서 집계
- 분산 스토리지에 데이터를 넣는 단계에서는 '프로세스 시간' 사용
- 파일을 모두 검색하는 풀 스캔은 비효율적
## 시계열 인덱스
- 시계열 인덱스: 이벤트 시간에 대해 인덱스를 만드는 것
- 짧은 범위의 특정 시간에 맞춘 데이터 집계에 유용
## 조건절 푸쉬다운
- 칼럼의 통계정보를 이용하여 최적화가 이루어짐
- 필요 최소한의 데이터만을 읽도록 하는 최적화 > 풀 스캔을 피할 수 있다
## 이벤트 시간에 의한 분할
- 기존 프로세스시간으로 파일을 나누는 것에서 이벤트 시간을 사용하여 테이블을 분할하는 것
- 시간을 이용하여 분할된 테이블을 시계열 테이블이라고 한다.
- 데이터 추가를 어떻게 구현하느냐가 매우 중요
- 데이터 수집은 프로세스 시간을 사용하고, 데이터 마트에서 이벤트 시간을 사용하는 것이 더 좋은 방법

# 비구조화 데이터의 분산 스토리지
## NoSQL 데이터베이스에 의한 데이터 활용
- 객체 스토리지상의 파일을 교체하기 어려움
- 쓰기 빈도가 높은 데이터는 다른 분산 데이터베이스에 저장하도록 함
- 중요한 데이터는 트랜잭션 처리에 의해 고려된 데이터베이스에 기록하는 것이 원칙
## 분산 KVS
- 모든 데이터를 키값 쌍으로 저장하도록 설계된 데이터 저장소
- 몇 KB 정도의 데이터를 초당 수만 번 읽고 쓰는 경우
- 모든 데이터에 고유의 키를 지정하고 부하 분산을 위해 이용(노드 배치)
## 와이드 칼럼 스토어
- 2개 이상의 임의의 키에 데이터를 저장할 수 있도록 한 것
- 행 키와 칼럼 명의 조합에 대해 값을 저장
- 성능 향상이 목적
## 도큐먼트 스토어
- 데이터 처리의 유연성이 목적
- 스키마를 정하지 않고 데이터 처리를 할 수 있다
- 외부 데이터를 저장하는데 적합
## 검색 엔진
- 텍스트 데이터를 검색하기 위해 '역 색인'을 만든다
- 텍스트 데이터, 스키마리스 데이터 집계에 사용
- 데이터 축적보다는 집계 시스템으로 이용된다
